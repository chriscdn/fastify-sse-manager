{"version":3,"file":"client.cjs","sources":["../src/client.ts"],"sourcesContent":["class Client<T> {\n  private eventSource: EventSource | null;\n  private _callbacks: Record<string, any>;\n\n  private onOpenBound: (event: MessageEvent) => void;\n  private onErrorBound: (event: MessageEvent) => void;\n  private closeBound: (event: MessageEvent) => void;\n\n  constructor(path: string) {\n    this.eventSource = new EventSource(path);\n\n    this.onOpenBound = this.onOpen.bind(this);\n    this.onErrorBound = this.onError.bind(this);\n    this.closeBound = this.close.bind(this);\n\n    // open and error are reserved\n    this.eventSource.addEventListener(\"open\", this.onOpenBound);\n    this.eventSource.addEventListener(\"error\", this.onErrorBound);\n\n    // close is a standard message, hijacked for our purposes\n    this.eventSource.addEventListener(\n      \"close\",\n      this.closeBound,\n    );\n\n    // keep record of our callback functions to make them available to removeEventListener\n    this._callbacks = {};\n  }\n\n  onOpen(event: MessageEvent) {\n    // console.log(\"onOpen\");\n  }\n  onError(event: MessageEvent) {\n    // console.log(\"onError\");\n  }\n\n  close() {\n    // close and cleanup\n    if (this.eventSource) {\n      this.eventSource.removeEventListener(\"open\", this.onOpenBound);\n      this.eventSource.removeEventListener(\"error\", this.onErrorBound);\n      this.eventSource.removeEventListener(\"close\", this.closeBound);\n      this.removeAllEventListener();\n      // this._callbacks = {};\n      this.eventSource.close();\n      this.eventSource = null;\n    }\n  }\n\n  addEventListener<\n    EMap extends Record<string, any>,\n    T extends keyof EMap & string,\n  >(\n    eventName: T,\n    _callback: ({ type, data }: { type: T; data: EMap[T] }) => void,\n  ) {\n    const callback = (event: MessageEvent) => {\n      const type = event.type as T;\n      const data = JSON.parse(event.data);\n\n      _callback({\n        type,\n        data,\n      });\n    };\n\n    // Only one listenter at a time per event.  If a second is needed, then change the code and document why.\n    this.removeEventListener(eventName);\n\n    this._callbacks[eventName] = callback;\n\n    this.eventSource?.addEventListener(eventName, callback);\n  }\n\n  removeEventListener(eventName: string) {\n    const callback = this._callbacks[eventName];\n\n    if (callback) {\n      this.eventSource?.removeEventListener(eventName, callback);\n      delete this._callbacks[eventName];\n    }\n  }\n\n  removeAllEventListener() {\n    Object.keys(this._callbacks).forEach((callbackName) =>\n      this.removeEventListener(callbackName)\n    );\n  }\n}\n\nexport { Client };\n"],"names":["Client","path","this","eventSource","_callbacks","onOpenBound","onErrorBound","closeBound","EventSource","onOpen","bind","onError","close","addEventListener","_proto","prototype","event","removeEventListener","removeAllEventListener","eventName","_callback","_this$eventSource","callback","type","data","JSON","parse","_this$eventSource2","_this","Object","keys","forEach","callbackName"],"mappings":"uCAQE,SAAAA,EAAYC,GAAYC,KAPhBC,iBACAC,EAAAA,KAAAA,uBAEAC,iBAAW,EAAAH,KACXI,kBACAC,EAAAA,KAAAA,kBAGNL,KAAKC,YAAc,IAAIK,YAAYP,GAEnCC,KAAKG,YAAcH,KAAKO,OAAOC,KAAKR,MACpCA,KAAKI,aAAeJ,KAAKS,QAAQD,KAAKR,MACtCA,KAAKK,WAAaL,KAAKU,MAAMF,KAAKR,MAGlCA,KAAKC,YAAYU,iBAAiB,OAAQX,KAAKG,aAC/CH,KAAKC,YAAYU,iBAAiB,QAASX,KAAKI,cAGhDJ,KAAKC,YAAYU,iBACf,QACAX,KAAKK,YAIPL,KAAKE,WAAa,CACpB,CAAA,CAAC,IAAAU,EAAAd,EAAAe,UA4DAf,OA5DAc,EAEDL,OAAA,SAAOO,GAAmB,EAEzBF,EACDH,QAAA,SAAQK,KAEPF,EAEDF,MAAA,WAEMV,KAAKC,cACPD,KAAKC,YAAYc,oBAAoB,OAAQf,KAAKG,aAClDH,KAAKC,YAAYc,oBAAoB,QAASf,KAAKI,cACnDJ,KAAKC,YAAYc,oBAAoB,QAASf,KAAKK,YACnDL,KAAKgB,yBAELhB,KAAKC,YAAYS,QACjBV,KAAKC,YAAc,KAEvB,EAACW,EAEDD,iBAAA,SAIEM,EACAC,GAA+D,IAAAC,EAEzDC,EAAW,SAACN,GAChB,IAAMO,EAAOP,EAAMO,KACbC,EAAOC,KAAKC,MAAMV,EAAMQ,MAE9BJ,EAAU,CACRG,KAAAA,EACAC,KAAAA,GAEJ,EAGAtB,KAAKe,oBAAoBE,GAEzBjB,KAAKE,WAAWe,GAAaG,EAEb,OAAhBD,EAAInB,KAACC,cAALkB,EAAkBR,iBAAiBM,EAAWG,EAChD,EAACR,EAEDG,oBAAA,SAAoBE,GAClB,IAEcQ,EAFRL,EAAWpB,KAAKE,WAAWe,GAE7BG,IACFK,OAAAA,EAAIzB,KAACC,cAALwB,EAAkBV,oBAAoBE,EAAWG,UAC1CpB,KAAKE,WAAWe,GAE3B,EAACL,EAEDI,uBAAA,WAAsBU,IAAAA,EACpBC,KAAAA,OAAOC,KAAK5B,KAAKE,YAAY2B,QAAQ,SAACC,GAAY,OAChDJ,EAAKX,oBAAoBe,EAAa,EAE1C,EAAChC,CAAA"}